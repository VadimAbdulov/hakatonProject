import{isPaint as t,preparePaint as e}from"@nextgis/paint";import{propertiesFilter as i}from"@nextgis/properties-filter";import{deepmerge as s,getBoundsFeature as r,defined as o,checkExtent as n,deprecatedMapClick as a}from"@nextgis/utils";import{EventEmitter as l}from"events";const h={};function d(t){return h[t]}function c(t,e){h[t]=e}function p(t,e){const i=document.createElement("div");let s=!1;e.getStatus?s=e.getStatus():e.status&&(s=e.status);const r=e.title||"",o=e.html;function n(){r&&(i.title="string"==typeof r?r:s?r.on:r.off,i.setAttribute("aria-label",i.title))}function a(t){t instanceof HTMLElement?(i.innerHTML="",i.appendChild(t)):"string"==typeof t&&(i.innerHTML=t)}function l(){o&&("string"==typeof o||o instanceof HTMLElement?a(o):a(s?o.on:o.off),i.setAttribute("aria-label",i.title))}function h(t,e){t.split(" ").forEach((t=>{e?i.classList.add(t):i.classList.remove(t)}))}function d(){e.addClassOn&&h(e.addClassOn,s),e.addClassOff&&h(e.addClassOff,!s)}n(),l(),e.addClass&&h(e.addClass,!0),d();const c=t=>{void 0!==t&&(s=t),l(),n(),d()},p=t=>{if(s=void 0!==t?t:!s,e.onClick){const t=e.onClick(s);Promise.resolve(t).then((()=>c())).catch((()=>s=!s))}else c()},u=t({html:i,onClick:p});return u.onClick=p,u.changeStatus=c,u}function u(t){const e={};for(let s=0;s<t.length;s++)e[t[s]]=1+(e[t[s]]||0);let i;for(const s in e){e[s]>((void 0!==i?e[i]:0)||0)&&(i=s)}return i}function y(t){let e;if("FeatureCollection"===t.type){e=u(t.features.map((t=>t.geometry.type)))}else if("GeometryCollection"===t.type){e=u(t.geometries.map((t=>t.type)))}else e="Feature"===t.type?t.geometry.type:t.type;return e}const m={polygon:"path",line:"path",point:"circle"},f={Point:"point",LineString:"line",MultiPoint:"point",Polygon:"polygon",MultiLineString:"line",MultiPolygon:"polygon"};function v(e){if(e.data){const i=f[y(e.data)],s=e.paint;s&&t(s)&&(s.type=s.type?s.type:"polygon"===i||"line"===i?"path":"html"in s||"className"in s?"icon":m[i]),e.type=e.type||i}return e}var L=Object.defineProperty,g=(t,e,i)=>((t,e,i)=>e in t?L(t,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[e]=i)(t,"symbol"!=typeof e?e+"":e,i);class b{constructor(){g(this,"backspace",8),g(this,"tab",9),g(this,"enter",13),g(this,"shift",16),g(this,"ctrl",17),g(this,"alt",18),g(this,"pause/break",19),g(this,"caps_lock",20),g(this,"escape",27),g(this,"page_up",33),g(this,"page_down",34),g(this,"end",35),g(this,"home",36),g(this,"left_arrow",37),g(this,"up_arrow",38),g(this,"right_arrow",39),g(this,"down_arrow",40),g(this,"insert",45),g(this,"delete",46),g(this,"left_window_key",91),g(this,"right_window_key",92),g(this,"select_key",93),g(this,"numpad_0",96),g(this,"numpad_1",97),g(this,"numpad_2",98),g(this,"numpad_3",99),g(this,"numpad_4",100),g(this,"numpad_5",101),g(this,"numpad_6",102),g(this,"numpad_7",103),g(this,"numpad_8",104),g(this,"numpad_9",105),g(this,"multiply",106),g(this,"add",107),g(this,"subtract",109),g(this,"decimal_point",110),g(this,"divide",111),g(this,"f1",112),g(this,"f2",113),g(this,"f3",114),g(this,"f4",115),g(this,"f5",116),g(this,"f6",117),g(this,"f7",118),g(this,"f8",119),g(this,"f9",120),g(this,"f10",121),g(this,"f11",122),g(this,"f12",123),g(this,"num_lock",144),g(this,"scroll_lock",145),g(this,"semi-colon",186),g(this,"equal_sign",187),g(this,",",188),g(this,"-",189),g(this,".",190),g(this,"/",191),g(this,"`",192),g(this,"[",219),g(this,"\\",220),g(this,"]",221),g(this,"'",222)}}var _=Object.defineProperty,w=(t,e,i)=>((t,e,i)=>e in t?_(t,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[e]=i)(t,"symbol"!=typeof e?e+"":e,i);var C=Object.defineProperty,A=(t,e,i)=>((t,e,i)=>e in t?C(t,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[e]=i)(t,"symbol"!=typeof e?e+"":e,i);class P{constructor(t,e){this.webMap=t,A(this,"name"),A(this,"event"),A(this,"value"),e&&(e.value&&this.setValue(e.value),e.name&&(this.name=e.name),e.event&&(this.event="string"==typeof e.event?[e.event]:e.event))}getValue(){return this.value}setValue(t){this.value=t}}var O=Object.defineProperty,k=(t,e,i)=>((t,e,i)=>e in t?O(t,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[e]=i)(t,"symbol"!=typeof e?e+"":e,i);class S extends P{constructor(){super(...arguments),k(this,"name","bounds"),k(this,"event",["moveend"])}getValue(){return this.webMap.getBounds()}setValue(t){this.webMap.setView({bounds:t})}toString(){const t=this.getValue();if(t)return t.slice(0,4).map((t=>t.toFixed(5))).join("_")}parse(t){return t.split("_").map(Number)}}var E=Object.defineProperty,x=(t,e,i)=>((t,e,i)=>e in t?E(t,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[e]=i)(t,"symbol"!=typeof e?e+"":e,i);class M extends P{constructor(){super(...arguments),x(this,"name","center"),x(this,"event",["moveend"])}getValue(){return this.webMap.getCenter()}setValue(t){this.webMap.setCenter(t)}toString(){const t=this.getValue();if(t){const e=t.map((t=>t.toFixed(5)));return e[0]+"_"+e[1]}return""}parse(t){return t.split("_").map(Number)}}var F=Object.defineProperty,V=(t,e,i)=>((t,e,i)=>e in t?F(t,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[e]=i)(t,"symbol"!=typeof e?e+"":e,i);class B extends P{constructor(){super(...arguments),V(this,"name","zoom"),V(this,"event",["zoomend"])}getValue(){const t=this.webMap.getZoom();return void 0!==t?Math.round(t):void 0}setValue(t){this.webMap.setZoom(t)}toString(){return String(this.getValue())}parse(t){return Number(t)}}var z=Object.defineProperty,I=(t,e,i)=>((t,e,i)=>e in t?z(t,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[e]=i)(t,"symbol"!=typeof e?e+"":e,i),j=(t,e,i)=>new Promise(((s,r)=>{var o=t=>{try{a(i.next(t))}catch(e){r(e)}},n=t=>{try{a(i.throw(t))}catch(e){r(e)}},a=t=>t.done?s(t.value):Promise.resolve(t.value).then(o,n);a((i=i.apply(t,e)).next())}));let T=0;const Z={minZoom:0,maxZoom:22,paint:{color:"#0000ff",opacity:.4,strokeOpacity:1,stroke:!0,radius:8,weight:1},selectedPaint:{color:"#00008b",opacity:.4,strokeOpacity:1,stroke:!0,radius:12,weight:1},create:!0},D=class t{constructor(e){I(this,"options",Z),I(this,"emitter",new l),I(this,"keys",t.keys),I(this,"mapAdapter"),I(this,"runtimeParams",[]),I(this,"getPaintFunctions",t.getPaintFunctions),I(this,"mapStateItems",[M,B,S]),I(this,"id",T++),I(this,"mapState",[]),I(this,"_initMapState",{}),I(this,"_starterKits"),I(this,"_extent"),I(this,"_eventsStatus",{}),I(this,"_coordFromMapClickAbort"),I(this,"_mapEvents",{}),this.mapAdapter=e.mapAdapter,this._starterKits=e.starterKits||[],e&&(this.options=s(Z||{},e)),this.options.runtimeParams&&(this.runtimeParams=this.options.runtimeParams),this._addEventsListeners(),this.options.tileJson&&this._setTileJsonOptions(this.options.tileJson),this.options.create&&this.create()}getId(){return this.id}create(){return j(this,null,(function*(){return this.getEventStatus("create")||(yield this._setInitMapState(this.mapStateItems),yield this._setupMap(),this._emitStatusEvent("create",this)),this}))}setRuntimeParams(t){this.runtimeParams.push(t)}destroy(){this._removeEventListeners(),function(t){for(const e in t)delete t[e]}(this._emitStatusEvent),this.mapAdapter.destroy&&this.mapAdapter.destroy()}mapStateWithFunc(t){const e={};return this.mapState.forEach((i=>{e[i.name]=t(i)})),e}getStateAsString(){return this.mapStateWithFunc((t=>t.toString()))}getState(){return this.mapStateWithFunc((t=>t.getValue()))}getRuntimeParams(){const t={};return this.mapState.forEach((e=>{for(const i of this.runtimeParams){const s=i.get(e.name);if(void 0!==s){t[e.name]=e.parse(s);break}}})),t}getContainer(){if(this.mapAdapter.getContainer)return this.mapAdapter.getContainer();if(this.options.target){if(this.options.target instanceof HTMLElement)return this.options.target;if("string"==typeof this.options.target){const t=document.getElementById(this.options.target);if(t)return t}}}setCursor(t){this.onLoad().then((()=>{this.mapAdapter.setCursor&&this.mapAdapter.setCursor(t)}))}getCursor(){if(this.mapAdapter.getCursor)return this.mapAdapter.getCursor();const t=this.getContainer();return t?t.style.cursor:void 0}setCenter(t){return this.mapAdapter.setCenter(t),this}getCenter(){return this.mapAdapter.getCenter()}getBounds(){if(this.mapAdapter.getBounds)return this.mapAdapter.getBounds()}getBoundsPolygon(){const t=this.getBounds();if(t){return r(t)}}setZoom(t){return this.mapAdapter.setZoom(t),this}getZoom(){const t=this.mapAdapter.getZoom();if("number"==typeof t)return t}zoomIn(){if(this.mapAdapter.zoomIn)this.mapAdapter.zoomIn();else{const t=this.getZoom();if(void 0!==t){this.setZoom(t+1)}}}zoomOut(){if(this.mapAdapter.zoomOut)this.mapAdapter.zoomOut();else{const t=this.getZoom();if(void 0!==t){this.setZoom(t-1)}}}setView(t,e){if(Array.isArray(t)){const i=t;this.mapAdapter.setView&&i&&o(e)?this.mapAdapter.setView(i,e):(i&&this.mapAdapter.setCenter(i),o(e)&&this.mapAdapter.setZoom(e))}else{this.mapAdapter.setView&&this.mapAdapter.setView(t)}}fitBounds(t,e){return n(t),t.every((t=>o(t)))&&(t[1]<-85.06&&(t[1]=-85.06),t[3]>85.06&&(t[3]=85.06),this.mapAdapter.fitBounds(t,e)),this}getEventStatus(t){const e=this._eventsStatus[t];return null!=e&&e}onLoad(t="create"){return new Promise((e=>{this.getEventStatus(t)?e(this):this.emitter.once(t,(()=>{e(this)}))}))}onMapLoad(t){return new Promise((e=>{var i;const s=()=>{const i=this.mapAdapter;t&&t(i),i&&e(i)},r=null==(i=this.mapAdapter.isLoaded)||i;this.mapAdapter.map&&r?s():this.mapAdapter.emitter.once("create",(()=>{s()}))}))}getLayerAdapters(){return this.mapAdapter.layerAdapters}getLayerAdapter(t){return this.mapAdapter.layerAdapters[t]}locate(t,e){if(this.mapAdapter&&this.mapAdapter.locate)return this.mapAdapter.locate(t,e);return{stop:()=>({})}}stopGetCoordFromMapClick(){this._coordFromMapClickAbort&&(this._coordFromMapClickAbort(),this._coordFromMapClickAbort=void 0)}getCoordFromMapClick(){return this._coordFromMapClickAbort?this.getCoordFromMapClick():new Promise(((t,e)=>{const i=this.getCursor()||"grab";this._removeEventListeners({include:["click"]}),this.setCursor("crosshair");const s=()=>{this.setCursor(i),this._addEventsListeners({include:["click"]}),this.mapAdapter.emitter.off("click",r),this._coordFromMapClickAbort=void 0},r=e=>{s(),a(e),t(e.lngLat)};this.mapAdapter.emitter.once("click",r),this._coordFromMapClickAbort=s}))}_emitStatusEvent(t,e){const i=t;this._eventsStatus[i]=!0,this.emitter.emit(i,e)}_addLayerProviders(){return j(this,null,(function*(){}))}_onLoadSync(){return j(this,null,(function*(){}))}_setupMap(){return j(this,null,(function*(){if(!this.mapAdapter)throw new Error("WebMap `mapAdapter` option is not set");return yield this.mapAdapter.create(this.options),this._zoomToInitialExtent(),yield this._addLayerProviders(),yield this._onLoadSync(),this._emitStatusEvent("build-map",this.mapAdapter),this}))}_setTileJsonOptions(t){t.center&&(this.options.center=t.center),t.bounds&&(this.options.bounds=t.bounds),o(t.maxzoom)&&(this.options.zoom=t.maxzoom),o(t.minzoom)&&(this.options.zoom=t.minzoom),o(t.maxzoom)&&o(t.minzoom)&&(this.options.zoom=(t.maxzoom+t.minzoom)/2)}_zoomToInitialExtent(){const{center:t,zoom:e,bounds:i}=this.options;this._extent?this.fitBounds(this._extent):t&&e?this.setView(t,e):i&&(this.fitBounds(i),void 0!==e&&this.setZoom(e))}_setInitMapState(t){for(const e of t){const t=new e(this);this.mapState.push(t);for(const e of this.runtimeParams){const i=e.get(t.name);if(void 0!==i){const e=t.parse(i);this._initMapState[t.name]=e,Object.defineProperty(this.options,t.name,{value:e,configurable:!0,enumerable:!0});break}}}}_addEventsListeners(t){let e=["preclick","click","zoomstart","zoom","zoomend","movestart","move","moveend","mousemove","mouseout","mouseover"];t&&t.include&&(e=e.filter((e=>t.include.includes(e)))),e.forEach((t=>{this._mapEvents[t]=e=>{if(this.runtimeParams.length){this.mapState.filter((e=>e.event.includes(t))).forEach((t=>{const e=t.toString();this.runtimeParams.forEach((i=>{i.set(t.name,e)}))}))}this._eventsStatus&&this.emitter.emit(t,e)};const e=this._mapEvents[t];e&&this.mapAdapter.emitter.on(t,e)}))}_removeEventListeners(t){let e=Object.entries(this._mapEvents);t&&t.include&&(e=e.filter((e=>t.include.includes(e[0])))),e.forEach((([t,e])=>{e&&this.mapAdapter.emitter.removeListener(t,e)}))}};I(D,"keys",new class{constructor(){w(this,"keyCodeAlias",new b),w(this,"keys",{}),w(this,"_windowOnFocus"),w(this,"_keysPressed"),w(this,"_keysReleased"),this._windowOnFocus=this.windowOnFocus.bind(this),this._keysPressed=this.keysPressed.bind(this),this._keysReleased=this.keysReleased.bind(this),this.addKeyboardEventsListener()}pressed(t){const e=this.keyCodeAlias[t];return!!e&&this.keys[e]}addKeyboardEventsListener(){"undefined"!=typeof window&&(window.addEventListener("focus",this._windowOnFocus,!1),window.addEventListener("keydown",this._keysPressed,!1),window.addEventListener("keyup",this._keysReleased,!1))}removeKeyboardEventsListener(){"undefined"!=typeof window&&(window.removeEventListener("focus",this._windowOnFocus,!1),window.removeEventListener("keydown",this._keysPressed,!1),window.removeEventListener("keyup",this._keysReleased,!1))}keysPressed(t){t.stopPropagation(),this.keys[t.keyCode]||(this.keys[t.keyCode]=!0)}keysReleased(t){t.stopPropagation(),this.keys[t.keyCode]=!1}windowOnFocus(){this.keys={}}}),I(D,"getPaintFunctions");let J=D;var R=Object.defineProperty,N=Object.defineProperties,G=Object.getOwnPropertyDescriptors,K=Object.getOwnPropertySymbols,Q=Object.prototype.hasOwnProperty,H=Object.prototype.propertyIsEnumerable,W=(t,e,i)=>e in t?R(t,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[e]=i,U=(t,e)=>{for(var i in e||(e={}))Q.call(e,i)&&W(t,i,e[i]);if(K)for(var i of K(e))H.call(e,i)&&W(t,i,e[i]);return t},q=(t,e)=>N(t,G(e)),$=(t,e,i)=>W(t,"symbol"!=typeof e?e+"":e,i),X=(t,e,i)=>new Promise(((s,r)=>{var o=t=>{try{a(i.next(t))}catch(e){r(e)}},n=t=>{try{a(i.throw(t))}catch(e){r(e)}},a=t=>t.done?s(t.value):Promise.resolve(t.value).then(o,n);a((i=i.apply(t,e)).next())}));class Y extends J{constructor(t){super(t),$(this,"_layersIdCounter",1),$(this,"_layersOrderCounter",1),$(this,"_baselayers",[]),$(this,"_layers",{}),$(this,"_selectedLayers",[]);const e=this.options.tileJson;e&&this.emitter.once("build-map",(()=>this.addTileJsonLayer(e)))}fitLayer(t,e){return X(this,null,(function*(){const i=this.getLayer(t),s=i&&(i.getBounds||i.getExtent);if(s){const t=yield s.call(i);t&&this.fitBounds(t,e)}}))}isBaseLayer(t){const e=this.getLayer(t);if(e&&e.id)return-1!==this._baselayers.indexOf(e.id)}getBaseLayers(){const t=[];return this._baselayers.forEach((e=>{const i=this._layers[e];i&&t.push(i)})),t}getBaseLayersIds(){return this._baselayers}getLayer(t){return"string"==typeof t?this._layers[t]:t}getLayerId(t){const e=this.getLayer(t);if(e){if(e.id)return null==e?void 0:e.id;if(e&&e.options)return e.options.id}throw new Error("No id for layer")}getLayers(){return Object.keys(this._layers)}allLayers(){return this._layers}orderedLayers(){return Object.values(this._layers).sort(((t,e)=>t.order&&e.order?t.order-e.order:0))}findLayer(t){for(const e in this._layers){const i=this._layers[e];if(t(i))return i}}isLayerVisible(t){const e=this.getLayer(t);return!(!e||void 0===e.options.visibility)&&e.options.visibility}addBaseLayer(t,e){return X(this,null,(function*(){return yield this.addLayer(t,q(U({},e),{baselayer:!0}),void 0)}))}addLayer(t){return X(this,arguments,(function*(t,e={},i){var s,r;const n=this._layersIdCounter++,a=o(i)?i:void 0!==e.order?e.order:this.reserveOrder();let l;"string"==typeof t?l=this.getLayerAdapter(t):"function"==typeof t?l=t:"then"in t&&(l=yield t);const h=e;this._updateGeoJsonOptions(h);const d=null==(s=(e=U({id:String(n),order:a},e)).visibility)||s;if(e.visibility=!1,e.baselayer&&(e.order=0),this.options.onBeforeAddLayer){const t=this.options.onBeforeAddLayer({options:e,adapter:l});t&&(t.options&&(e=t.options),t.adapter&&(l=t.adapter))}if(void 0!==l){const t=new l(this.mapAdapter.map,e);let i;t.options=U(U({},e),t.options),t.options.baselayer&&(e.baselayer=!0,e.order=0,t.options.order=0),t.options.id&&(i=String(t.options.id),this._layers[i]=t),this._emitLayerEvent("layer:preadd",i||"",t),yield this.onMapLoad(),t.map=this.mapAdapter.map;const s=yield t.addLayer(t.options);if(t.layer=s,t.id=t.options.id||String(n),t.options.id=t.id,e.baselayer&&(t.options.order=0),t.order=null!=(r=t.options.order)?r:a,i&&delete this._layers[i],i=String(t.id),this._layers[i])throw Error(`layer with id '${i}' already exist`);i&&(this._layers[i]=t,h.filter&&this.filterLayer(t,h.filter),e.baselayer&&this._baselayers.push(i),d&&(yield this.showLayer(i)));const o=e.opacity;null!=o&&o<=1&&this.setLayerOpacity(t,o);const c=s&&(t.getBounds||t.getExtent);if(e.fit&&c){const e=yield c.call(t);e&&(yield this.fitBounds(e))}return e.onAdded&&e.onAdded(t),this._emitLayerEvent("layer:add",i,t),t}return Promise.reject("No adapter")}))}addLayerFromAsyncAdapter(t,e,i){return X(this,null,(function*(){const s=i||void 0!==e.order?e.order:this.reserveOrder(),r=t(),o=yield r;return o?this.addLayer(o,e,s):Promise.reject("No adapter")}))}removeLayers(t){for(const e in this._layers){let i=!0;t&&(i=t(e,this._layers[e])),i&&(this.removeLayer(e),delete this._layers[e])}}getLegend(t){return X(this,null,(function*(){const e=[];for(const i of this.orderedLayers())i.getLegend&&e.push(i.getLegend(t));return(yield Promise.all(e)).flat()}))}reserveOrder(){return this._layersOrderCounter++}removeOverlays(){this.removeLayers(((t,e)=>!(e&&e.options&&e.options.baselayer)))}removeLayer(t){const e=this.getLayer(t),i=e&&this.getLayerId(e);if(e&&i){if(this.emitter.emit("layer:preremove",e),e.beforeRemove&&e.beforeRemove(),e.removeLayer?e.removeLayer():this.mapAdapter.removeLayer(e.layer),e.options&&e.options.baselayer){const t=this._baselayers.indexOf(i);t&&this._baselayers.splice(t,1)}delete this._layers[i],this.emitter.emit("layer:remove",e)}}addGeoJsonLayer(t={},e){return(t=t||{}).multiselect=void 0!==t.multiselect&&t.multiselect,t.unselectOnSecondClick=void 0===t.unselectOnSecondClick||t.unselectOnSecondClick,e||(t=v(t)),t.paint=t.paint||{},this.addLayer(e||"GEOJSON",t)}addFeatureLayer(t={}){return this.addGeoJsonLayer(t)}addTileLayer(t,e={}){return this.addLayer("TILE",q(U({},e),{url:t}))}addImageLayer(t,e){let i;return"string"==typeof t?i=t:(i=t.url,e=t),this.addLayer("IMAGE",q(U({},e),{url:i}))}showLayer(t,e={}){return this.toggleLayer(t,!0,e)}hideLayer(t,e={}){return this.toggleLayer(t,!1,e)}toggleLayer(t,e,i={}){const s=this.getLayer(t),r=void 0!==e?e:!(s&&s.options.visibility),o=void 0!==i.silent&&i.silent,n=t=>X(this,null,(function*(){const e=String(t.id),i=r?"layer:show":"layer:hide";if(o||(this._emitLayerEvent(r?"layer:preshow":"layer:prehide",e,t),this._emitLayerEvent("layer:pretoggle",e,t)),r&&this.mapAdapter){const e=t.options.baselayer?0:t.options.order;if(t.options.baselayer&&this._baselayers.length){const e=this._baselayers.filter((e=>e!==t.id&&this.isLayerVisible(e)));for(const t of e)yield this.hideLayer(t)}t.showLayer?yield t.showLayer.call(t,t.layer):void 0!==t.layer&&(yield this.mapAdapter.showLayer(t.layer)),void 0!==e&&this.mapAdapter.setLayerOrder(t.layer,e,this._layers)}else t.hideLayer?yield t.hideLayer.call(t,t.layer):void 0!==t.layer&&(yield this.mapAdapter.hideLayer(t.layer));t.options.visibility=r,o||(this._emitLayerEvent(i,e,t),this._emitLayerEvent("layer:toggle",e,t))}));return s?this.onMapLoad().then((()=>n(s))):Promise.resolve()}updateLayer(t,e){const i=this.getLayer(t);if(i){if(i.updateLayer)return Promise.resolve(i.updateLayer(e));if(this.isLayerVisible(i))return this.hideLayer(i,{silent:!0}).then((()=>this.showLayer(i,{silent:!0})))}return Promise.resolve()}setLayerOpacity(t,e){const i=this.getLayer(t);i&&(i.setOpacity?i.setOpacity(e):this.mapAdapter.setLayerOpacity&&this.mapAdapter.setLayerOpacity(i.layer,e))}isLayerLabelVisible(t){var e;const i=this.getLayer(t);return i.isLabelVisible?i.isLabelVisible():null==(e=i.options.labelVisibility)||e}showLayerLabel(t){this.toggleLayerLabel(t,!0)}hideLayerLabel(t){this.toggleLayerLabel(t,!1)}toggleLayerLabel(t,e){const i=this.getLayer(t);return e=null!=e?e:!this.isLayerLabelVisible(t),i&&(e?i.showLabel&&(i.options.labelVisibility=!0,i.showLabel()):i.hideLabel&&(i.options.labelVisibility=!1,i.hideLabel()),i.id&&this._emitLayerEvent("layer:label:toggle",i.id,i)),e}selectLayer(t,e){const i=this.getLayer(t);if(i){i&&i.select&&i.select(e);const t=this.getLayerId(i);t&&this._selectedLayers.push(t)}}unSelectLayer(t,e){const i=this.getLayer(t);if(i){const t=i&&i;t.unselect&&t.unselect(e);const s=this.getLayerId(i);if(s){const t=this._selectedLayers.indexOf(s);-1!==t&&this._selectedLayers.splice(t,1)}}}unSelectLayers(){const t=Object.values(this.allLayers());let e;for(e of t)e.unselect&&e.unselect()}filterLayer(t,e){const i=this.getLayer(t);return i.filter?i.filter(e):[]}propertiesFilter(t,e,s){const r=this.getLayer(t);if(r){const t=r;if(t.propertiesFilter)return t.propertiesFilter(e,s);t.filter&&this.filterLayer(t,(t=>!t.feature||!t.feature.properties||i(t.feature.properties,e)))}return Promise.resolve()}removeLayerFilter(t){const e=this.getLayer(t);e.removeFilter?e.removeFilter():e.filter&&e.filter((()=>!0))}setLayerData(t,e){const i=this.getLayer(t);if(i){if(i.setData)return i.setData(e);if(i.clearLayer&&i.addData)return i.clearLayer(),i.addData(e)}return Promise.resolve()}addLayerData(t,e){const i=this.getLayer(t);i.addData&&i.addData(e)}clearLayerData(t,e){const i=this.getLayer(t);i&&i.clearLayer&&i.clearLayer(e)}setLayerPaint(t,e){const i=this.getLayer(t);e&&i&&i.setPaint&&i.setPaint(e)}setLayerSelectedPaint(t,e){const i=this.getLayer(t);e&&i&&i.setSelectedPaint&&i.setSelectedPaint(e)}updateLayerPaint(t,e){const i=this.getLayer(t);e&&i&&i.updatePaint&&i.updatePaint(e)}updateLayerSelectedPaint(t,e){const i=this.getLayer(t);e&&i&&i.updateSelectedPaint&&i.updateSelectedPaint(e)}getAttributions(t){const e=[];for(const i in this._layers){const s=this._layers[i];let r=!(void 0===t.onlyVisible||t.onlyVisible)||s.options.visibility;if(r&&t.onlyBaselayer&&(r=this._baselayers.includes(i)),r){const t=s.options&&s.options.attribution;t&&e.push(t)}}return e}getActiveBaseLayer(){const t=this.getBaseLayers().find((t=>this.isLayerVisible(t)));if(t)return this.getLayer(t)}addTileJsonLayer(t){return this.addLayer("TILE",{url:t.tiles[0],maxZoom:t.maxzoom,minZoom:t.minzoom,subdomains:t.scheme,attribution:t.attribution})}_emitLayerEvent(t,e,i){const s=String(t);if(o(e)&&s.startsWith("layer:")){const t=s.replace("layer:","layer-"+e+":");this.emitter.emit(t,i)}this.emitter.emit(t,i)}_onLayerClick(t){return X(this,null,(function*(){return this._emitLayerEvent("layer:click",t.layer.id||"",t),Promise.resolve(t)}))}_onLayerDoubleClick(t){return X(this,null,(function*(){return this._emitLayerEvent("layer:dblclick",t.layer.id||"",t),Promise.resolve(t)}))}_onLayerSelect(t){return X(this,null,(function*(){return this._emitLayerEvent("layer:select",t.layer.id||"",t),Promise.resolve(t)}))}_updateGeoJsonOptions(t){const{onSelect:i,onLayerSelect:s,onClick:r,onDoubleClick:n,onLayerClick:a,onMouseOut:l,onMouseOver:h}=t,d=r||a,c=n||a;t.onClick=t=>(d&&d(t),this._onLayerClick(t)),t.onDoubleClick=t=>(c&&c(t),this._onLayerDoubleClick(t)),t.onMouseOut=t=>{const e=t.layer.id;l&&l(t),o(e)&&this._emitLayerEvent("layer:mouseout",e,t)},t.onMouseOver=t=>{const e=t.layer.id;h&&h(t),o(e)&&this._emitLayerEvent("layer:mouseover",e,t)};const p=i||s;t.onSelect=t=>(p&&p(t),this._onLayerSelect(t)),t.nativePaint||(this.options.paint&&(t.paint=e({paint:t.paint||{},defaultPaint:this.options.paint,getPaintFunctions:this.getPaintFunctions})),t.selectedPaint&&this.options.selectedPaint&&(t.selectedPaint=e({paint:t.selectedPaint,defaultPaint:this.options.selectedPaint,getPaintFunctions:this.getPaintFunctions})))}}var tt=Object.defineProperty,et=(t,e,i)=>((t,e,i)=>e in t?tt(t,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[e]=i)(t,"symbol"!=typeof e?e+"":e,i),it=(t,e,i)=>new Promise(((s,r)=>{var o=t=>{try{a(i.next(t))}catch(e){r(e)}},n=t=>{try{a(i.throw(t))}catch(e){r(e)}},a=t=>t.done?s(t.value):Promise.resolve(t.value).then(o,n);a((i=i.apply(t,e)).next())}));const st=class t extends Y{constructor(){super(...arguments),et(this,"_loadControlQueue",{"top-right":[],"bottom-right":[],"top-left":[],"bottom-left":[]}),et(this,"_isControlLoading",{"top-right":!1,"bottom-right":!1,"top-left":!1,"bottom-left":!1})}addControl(t,e,i){return it(this,null,(function*(){let s;if(e=null!=e?e:"top-left",s="string"==typeof t?this.getControl(t,i):t,s)return new Promise((t=>{this._setControlQueue(e,(()=>it(this,null,(function*(){const i=yield s,r=this.mapAdapter.addControl(i,e);t(r)}))))}))}))}createControl(t,e){return it(this,null,(function*(){if(yield this.onLoad("build-map"),this.mapAdapter.createControl)return this.mapAdapter.createControl(t,e)}))}createButtonControl(t){return it(this,null,(function*(){if(yield this.onLoad("build-map"),this.mapAdapter.createButtonControl)return this.mapAdapter.createButtonControl(t)}))}createToggleControl(t){return it(this,null,(function*(){return yield this.onLoad("build-map"),this.mapAdapter.createToggleControl?this.mapAdapter.createToggleControl(t):this.mapAdapter.createButtonControl?p(this.mapAdapter.createButtonControl,t):void 0}))}removeControl(t){"remove"in t?t.remove():this.mapAdapter.removeControl&&Promise.resolve(t).then((t=>{this.mapAdapter.removeControl(t)}))}getControl(e,i){const s=this.mapAdapter.controlAdapters[e];if(s)return new s(i);{const s=t.controls[e];if(s)return s(this,i)}}getControlContainer(){if(this.mapAdapter.getControlContainer)return this.mapAdapter.getControlContainer()}_setControlQueue(t,e){this._loadControlQueue[t].push(e),this._isControlLoading[t]||this._applyControls(t)}_applyControls(t){return it(this,null,(function*(){if(this._loadControlQueue[t].length){this._isControlLoading[t]=!0;const e=this._loadControlQueue[t][0];yield e(),this._loadControlQueue[t].splice(0,1),this._applyControls(t)}else this._isControlLoading[t]=!1}))}};et(st,"controls",{CONTROL:(t,e)=>t.createControl(e.control,e.options),BUTTON:(t,e)=>t.createButtonControl(e),TOGGLE:(t,e)=>t.createToggleControl(e)});let rt=st;var ot=Object.getOwnPropertySymbols,nt=Object.prototype.hasOwnProperty,at=Object.prototype.propertyIsEnumerable,lt=(t,e)=>(e=Symbol[t])?e:Symbol.for("Symbol."+t),ht=(t,e,i)=>new Promise(((s,r)=>{var o=t=>{try{a(i.next(t))}catch(e){r(e)}},n=t=>{try{a(i.throw(t))}catch(e){r(e)}},a=t=>t.done?s(t.value):Promise.resolve(t.value).then(o,n);a((i=i.apply(t,e)).next())})),dt=(t,e,i)=>(e=t[lt("asyncIterator")])?e.call(t):(t=t[lt("iterator")](),e={},(i=(i,s)=>(s=t[i])&&(e[i]=e=>new Promise(((i,r,o)=>(e=s.call(t,e),o=e.done,Promise.resolve(e.value).then((t=>i({value:t,done:o})),r))))))("next"),i("return"),e);class ct extends rt{constructor(t){super(t),this._addControls(),c(this.id,this)}static get(t){return d(t)}_addLayerProviders(){return ht(this,null,(function*(){try{for(var t,e,i,s=dt(this._starterKits);t=!(e=yield s.next()).done;t=!1){const t=e.value;if(t.getLayerAdapters){const e=yield t.getLayerAdapters.call(t);if(e)try{for(var r,o,n,a=dt(e);r=!(o=yield a.next()).done;r=!1){const t=o.value,e=yield t.createAdapter(this);e&&(this.mapAdapter.layerAdapters[t.name]=e)}}catch(o){n=[o]}finally{try{r&&(o=a.return)&&(yield o.call(a))}finally{if(n)throw n[0]}}}}}catch(e){i=[e]}finally{try{t&&(e=s.return)&&(yield e.call(s))}finally{if(i)throw i[0]}}}))}_onLoadSync(){return ht(this,null,(function*(){try{for(var t,e,i,s=dt(this._starterKits);t=!(e=yield s.next()).done;t=!1){const t=e.value;if(t.onLoadSync)try{yield t.onLoadSync.call(t,this)}catch(r){console.error(r)}}}catch(e){i=[e]}finally{try{t&&(e=s.return)&&(yield e.call(s))}finally{if(i)throw i[0]}}}))}_addControls(){this.options.controls&&this.options.controls.forEach((t=>{let e=t,i={};"string"==typeof t&&this.options.controlsOptions&&this.options.controlsOptions[t]&&(i=this.options.controlsOptions[t],void 0!==i.control&&(e=i.control));const s=i,{position:r}=s,o=((t,e)=>{var i={};for(var s in t)nt.call(t,s)&&e.indexOf(s)<0&&(i[s]=t[s]);if(null!=t&&ot)for(var s of ot(t))e.indexOf(s)<0&&at.call(t,s)&&(i[s]=t[s]);return i})(s,["position"]);this.addControl(e,r||"top-left",o)})),this._emitStatusEvent("controls:create")}}function pt(){return["ZOOM","ATTRIBUTION"]}function ut(t){return e=this,i=null,s=function*(){return new ct(t).onLoad()},new Promise(((t,r)=>{var o=t=>{try{a(s.next(t))}catch(e){r(e)}},n=t=>{try{a(s.throw(t))}catch(e){r(e)}},a=e=>e.done?t(e.value):Promise.resolve(e.value).then(o,n);a((s=s.apply(e,i)).next())}));var e,i,s}export{ct as WebMap,rt as WebMapControls,Y as WebMapLayers,J as WebMapMain,p as createToggleControl,ut as createWebMap,y as detectGeometryType,u as findMostFrequentGeomType,pt as getDefaultControls,d as getWebMap,m as paintTypeAlias,c as setWebMap,f as typeAlias,v as updateGeoJsonAdapterOptions};
//# sourceMappingURL=webmap.esm-bundler.prod.js.map
