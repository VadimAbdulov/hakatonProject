{"version":3,"file":"properties-filter.global.js","sources":["../src/propertiesFilter.ts"],"sourcesContent":["import type { Feature } from 'geojson';\n\nimport type {\n  Operation,\n  Properties,\n  PropertiesFilter,\n  PropertyFilter,\n} from './interfaces';\n\nfunction reEscape(s: string): string {\n  return s.replace(/[-/\\\\^$*+?.()|[\\]{}]/g, '\\\\$&');\n}\n\nfunction like(b: string, a: string, iLike?: boolean): boolean {\n  a = String(a);\n  b = String(b);\n  if (a === b) return true;\n  if (iLike && a.toUpperCase() === b.toUpperCase()) return true;\n  const re = `^${reEscape(a)}$`.replace(/%/g, '.*').replace('_', '.');\n  return new RegExp(re, iLike ? 'i' : '').exec(b) !== null;\n}\n\nexport const operationsAliases: {\n  [key in Operation]: (a: any, b: any) => boolean;\n} = {\n  // greater(>)\n  gt: (a: any, b: any) => a > b,\n  // lower(<)\n  lt: (a: any, b: any) => a < b,\n  // greater or equal(>=)\n  ge: (a: any, b: any) => a >= b,\n  // lower or equal(<=)\n  le: (a: any, b: any) => a <= b,\n  // equal(=)\n  eq: (a: any, b: any) => a === b,\n  //  not equal(!=)\n  ne: (a: any, b: any) => a !== b,\n\n  in: (a: any, b: any[]) => b.indexOf(a) !== -1,\n  notin: (a: any, b: any[]) => b.indexOf(a) === -1,\n  // LIKE SQL statement(for strings compare)\n  like: (a: string, b: string) => {\n    return like(a, b);\n  },\n  // ILIKE SQL statement(for strings compare)\n  ilike: (a: string, b: string) => {\n    return like(a, b, true);\n  },\n};\n\nexport function isPropertyFilter(\n  filter: PropertyFilter | PropertiesFilter | string,\n): filter is PropertyFilter {\n  const pf = filter as PropertyFilter;\n  if (\n    pf.length === 3 &&\n    typeof pf[0] === 'string' &&\n    typeof pf[1] === 'string'\n  ) {\n    return true;\n  }\n  return false;\n}\n\n/** @deprecated use {@link isPropertyFilter} instead */\nexport function checkIfPropertyFilter(\n  filter: PropertyFilter | PropertiesFilter | string,\n): filter is PropertyFilter {\n  return isPropertyFilter(filter);\n}\n\nexport function featureFilter(\n  feature: Feature,\n  filters: PropertiesFilter,\n): boolean {\n  const properties: Properties = { ...feature.properties };\n  if (properties) {\n    // workaround to filter by feature id\n    properties.$id = feature.id;\n    return propertiesFilter(properties, filters);\n  }\n  return false;\n}\n\nexport function propertiesFilter<T extends Properties = Properties>(\n  properties: T,\n  filters: PropertiesFilter<T>,\n): boolean {\n  const logic = typeof filters[0] === 'string' ? filters[0] : 'all';\n  const filterFunction = (p: PropertyFilter | PropertiesFilter) => {\n    if (isPropertyFilter(p)) {\n      const [field, operation, value] = p;\n      const operationExec = operationsAliases[operation];\n      if (operationExec) {\n        if (operation === 'like' || operation === 'ilike') {\n          if (typeof field === 'string') {\n            let prop = '';\n            const value_ = field.replace(/^%?(\\w+)%?$/, (match, cleanField) => {\n              prop = properties[cleanField];\n              return field.replace(cleanField, value);\n            });\n            return operationExec(prop, value_);\n          }\n        }\n        return operationExec(properties[field], value);\n      }\n      return false;\n    } else {\n      return propertiesFilter(properties, p);\n    }\n  };\n  const filters_ = filters.filter((x) => Array.isArray(x)) as (\n    | PropertyFilter\n    | PropertiesFilter\n  )[];\n  return logic === 'any'\n    ? filters_.some(filterFunction)\n    : filters_.every(filterFunction);\n}\n"],"names":[],"mappings":"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"}