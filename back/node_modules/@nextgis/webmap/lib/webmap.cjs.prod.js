"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var t=require("@nextgis/paint"),e=require("@nextgis/properties-filter"),s=require("@nextgis/utils"),i=require("events");const r={};function o(t){return r[t]}function a(t,e){r[t]=e}function n(t,e){const s=document.createElement("div");let i=!1;e.getStatus?i=e.getStatus():e.status&&(i=e.status);const r=e.title||"",o=e.html;function a(){r&&(s.title="string"==typeof r?r:i?r.on:r.off,s.setAttribute("aria-label",s.title))}function n(t){t instanceof HTMLElement?(s.innerHTML="",s.appendChild(t)):"string"==typeof t&&(s.innerHTML=t)}function l(){o&&("string"==typeof o||o instanceof HTMLElement?n(o):n(i?o.on:o.off),s.setAttribute("aria-label",s.title))}function d(t,e){t.split(" ").forEach((t=>{e?s.classList.add(t):s.classList.remove(t)}))}function h(){e.addClassOn&&d(e.addClassOn,i),e.addClassOff&&d(e.addClassOff,!i)}a(),l(),e.addClass&&d(e.addClass,!0),h();const p=t=>{void 0!==t&&(i=t),l(),a(),h()},c=t=>{if(i=void 0!==t?t:!i,e.onClick){const t=e.onClick(i);Promise.resolve(t).then((()=>p())).catch((()=>i=!i))}else p()},u=t({html:s,onClick:c});return u.onClick=c,u.changeStatus=p,u}function l(t){const e={};for(let i=0;i<t.length;i++)e[t[i]]=1+(e[t[i]]||0);let s;for(const i in e){e[i]>((void 0!==s?e[s]:0)||0)&&(s=i)}return s}function d(t){let e;if("FeatureCollection"===t.type){e=l(t.features.map((t=>t.geometry.type)))}else if("GeometryCollection"===t.type){e=l(t.geometries.map((t=>t.type)))}else e="Feature"===t.type?t.geometry.type:t.type;return e}const h={polygon:"path",line:"path",point:"circle"},p={Point:"point",LineString:"line",MultiPoint:"point",Polygon:"polygon",MultiLineString:"line",MultiPolygon:"polygon"};function c(e){if(e.data){const s=p[d(e.data)],i=e.paint;i&&t.isPaint(i)&&(i.type=i.type?i.type:"polygon"===s||"line"===s?"path":"html"in i||"className"in i?"icon":h[s]),e.type=e.type||s}return e}var u=Object.defineProperty,y=(t,e,s)=>((t,e,s)=>e in t?u(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s)(t,"symbol"!=typeof e?e+"":e,s);class m{constructor(){y(this,"backspace",8),y(this,"tab",9),y(this,"enter",13),y(this,"shift",16),y(this,"ctrl",17),y(this,"alt",18),y(this,"pause/break",19),y(this,"caps_lock",20),y(this,"escape",27),y(this,"page_up",33),y(this,"page_down",34),y(this,"end",35),y(this,"home",36),y(this,"left_arrow",37),y(this,"up_arrow",38),y(this,"right_arrow",39),y(this,"down_arrow",40),y(this,"insert",45),y(this,"delete",46),y(this,"left_window_key",91),y(this,"right_window_key",92),y(this,"select_key",93),y(this,"numpad_0",96),y(this,"numpad_1",97),y(this,"numpad_2",98),y(this,"numpad_3",99),y(this,"numpad_4",100),y(this,"numpad_5",101),y(this,"numpad_6",102),y(this,"numpad_7",103),y(this,"numpad_8",104),y(this,"numpad_9",105),y(this,"multiply",106),y(this,"add",107),y(this,"subtract",109),y(this,"decimal_point",110),y(this,"divide",111),y(this,"f1",112),y(this,"f2",113),y(this,"f3",114),y(this,"f4",115),y(this,"f5",116),y(this,"f6",117),y(this,"f7",118),y(this,"f8",119),y(this,"f9",120),y(this,"f10",121),y(this,"f11",122),y(this,"f12",123),y(this,"num_lock",144),y(this,"scroll_lock",145),y(this,"semi-colon",186),y(this,"equal_sign",187),y(this,",",188),y(this,"-",189),y(this,".",190),y(this,"/",191),y(this,"`",192),y(this,"[",219),y(this,"\\",220),y(this,"]",221),y(this,"'",222)}}var f=Object.defineProperty,L=(t,e,s)=>((t,e,s)=>e in t?f(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s)(t,"symbol"!=typeof e?e+"":e,s);var g=Object.defineProperty,v=(t,e,s)=>((t,e,s)=>e in t?g(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s)(t,"symbol"!=typeof e?e+"":e,s);class b{constructor(t,e){this.webMap=t,v(this,"name"),v(this,"event"),v(this,"value"),e&&(e.value&&this.setValue(e.value),e.name&&(this.name=e.name),e.event&&(this.event="string"==typeof e.event?[e.event]:e.event))}getValue(){return this.value}setValue(t){this.value=t}}var _=Object.defineProperty,w=(t,e,s)=>((t,e,s)=>e in t?_(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s)(t,"symbol"!=typeof e?e+"":e,s);class C extends b{constructor(){super(...arguments),w(this,"name","bounds"),w(this,"event",["moveend"])}getValue(){return this.webMap.getBounds()}setValue(t){this.webMap.setView({bounds:t})}toString(){const t=this.getValue();if(t)return t.slice(0,4).map((t=>t.toFixed(5))).join("_")}parse(t){return t.split("_").map(Number)}}var A=Object.defineProperty,P=(t,e,s)=>((t,e,s)=>e in t?A(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s)(t,"symbol"!=typeof e?e+"":e,s);class k extends b{constructor(){super(...arguments),P(this,"name","center"),P(this,"event",["moveend"])}getValue(){return this.webMap.getCenter()}setValue(t){this.webMap.setCenter(t)}toString(){const t=this.getValue();if(t){const e=t.map((t=>t.toFixed(5)));return e[0]+"_"+e[1]}return""}parse(t){return t.split("_").map(Number)}}var O=Object.defineProperty,E=(t,e,s)=>((t,e,s)=>e in t?O(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s)(t,"symbol"!=typeof e?e+"":e,s);class S extends b{constructor(){super(...arguments),E(this,"name","zoom"),E(this,"event",["zoomend"])}getValue(){const t=this.webMap.getZoom();return void 0!==t?Math.round(t):void 0}setValue(t){this.webMap.setZoom(t)}toString(){return String(this.getValue())}parse(t){return Number(t)}}var M=Object.defineProperty,x=(t,e,s)=>((t,e,s)=>e in t?M(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s)(t,"symbol"!=typeof e?e+"":e,s);let F=0;const B={minZoom:0,maxZoom:22,paint:{color:"#0000ff",opacity:.4,strokeOpacity:1,stroke:!0,radius:8,weight:1},selectedPaint:{color:"#00008b",opacity:.4,strokeOpacity:1,stroke:!0,radius:12,weight:1},create:!0},V=class t{constructor(e){x(this,"options",B),x(this,"emitter",new i.EventEmitter),x(this,"keys",t.keys),x(this,"mapAdapter"),x(this,"runtimeParams",[]),x(this,"getPaintFunctions",t.getPaintFunctions),x(this,"mapStateItems",[k,S,C]),x(this,"id",F++),x(this,"mapState",[]),x(this,"_initMapState",{}),x(this,"_starterKits"),x(this,"_extent"),x(this,"_eventsStatus",{}),x(this,"_coordFromMapClickAbort"),x(this,"_mapEvents",{}),this.mapAdapter=e.mapAdapter,this._starterKits=e.starterKits||[],e&&(this.options=s.deepmerge(B||{},e)),this.options.runtimeParams&&(this.runtimeParams=this.options.runtimeParams),this._addEventsListeners(),this.options.tileJson&&this._setTileJsonOptions(this.options.tileJson),this.options.create&&this.create()}getId(){return this.id}async create(){return this.getEventStatus("create")||(await this._setInitMapState(this.mapStateItems),await this._setupMap(),this._emitStatusEvent("create",this)),this}setRuntimeParams(t){this.runtimeParams.push(t)}destroy(){this._removeEventListeners(),function(t){for(const e in t)delete t[e]}(this._emitStatusEvent),this.mapAdapter.destroy&&this.mapAdapter.destroy()}mapStateWithFunc(t){const e={};return this.mapState.forEach((s=>{e[s.name]=t(s)})),e}getStateAsString(){return this.mapStateWithFunc((t=>t.toString()))}getState(){return this.mapStateWithFunc((t=>t.getValue()))}getRuntimeParams(){const t={};return this.mapState.forEach((e=>{for(const s of this.runtimeParams){const i=s.get(e.name);if(void 0!==i){t[e.name]=e.parse(i);break}}})),t}getContainer(){if(this.mapAdapter.getContainer)return this.mapAdapter.getContainer();if(this.options.target){if(this.options.target instanceof HTMLElement)return this.options.target;if("string"==typeof this.options.target){const t=document.getElementById(this.options.target);if(t)return t}}}setCursor(t){this.onLoad().then((()=>{this.mapAdapter.setCursor&&this.mapAdapter.setCursor(t)}))}getCursor(){if(this.mapAdapter.getCursor)return this.mapAdapter.getCursor();const t=this.getContainer();return t?t.style.cursor:void 0}setCenter(t){return this.mapAdapter.setCenter(t),this}getCenter(){return this.mapAdapter.getCenter()}getBounds(){if(this.mapAdapter.getBounds)return this.mapAdapter.getBounds()}getBoundsPolygon(){const t=this.getBounds();if(t){return s.getBoundsFeature(t)}}setZoom(t){return this.mapAdapter.setZoom(t),this}getZoom(){const t=this.mapAdapter.getZoom();if("number"==typeof t)return t}zoomIn(){if(this.mapAdapter.zoomIn)this.mapAdapter.zoomIn();else{const t=this.getZoom();if(void 0!==t){this.setZoom(t+1)}}}zoomOut(){if(this.mapAdapter.zoomOut)this.mapAdapter.zoomOut();else{const t=this.getZoom();if(void 0!==t){this.setZoom(t-1)}}}setView(t,e){if(Array.isArray(t)){const i=t;this.mapAdapter.setView&&i&&s.defined(e)?this.mapAdapter.setView(i,e):(i&&this.mapAdapter.setCenter(i),s.defined(e)&&this.mapAdapter.setZoom(e))}else{this.mapAdapter.setView&&this.mapAdapter.setView(t)}}fitBounds(t,e){return s.checkExtent(t),t.every((t=>s.defined(t)))&&(t[1]<-85.06&&(t[1]=-85.06),t[3]>85.06&&(t[3]=85.06),this.mapAdapter.fitBounds(t,e)),this}getEventStatus(t){const e=this._eventsStatus[t];return null!=e&&e}onLoad(t="create"){return new Promise((e=>{this.getEventStatus(t)?e(this):this.emitter.once(t,(()=>{e(this)}))}))}onMapLoad(t){return new Promise((e=>{var s;const i=()=>{const s=this.mapAdapter;t&&t(s),s&&e(s)},r=null==(s=this.mapAdapter.isLoaded)||s;this.mapAdapter.map&&r?i():this.mapAdapter.emitter.once("create",(()=>{i()}))}))}getLayerAdapters(){return this.mapAdapter.layerAdapters}getLayerAdapter(t){return this.mapAdapter.layerAdapters[t]}locate(t,e){if(this.mapAdapter&&this.mapAdapter.locate)return this.mapAdapter.locate(t,e);return{stop:()=>({})}}stopGetCoordFromMapClick(){this._coordFromMapClickAbort&&(this._coordFromMapClickAbort(),this._coordFromMapClickAbort=void 0)}getCoordFromMapClick(){return this._coordFromMapClickAbort?this.getCoordFromMapClick():new Promise(((t,e)=>{const i=this.getCursor()||"grab";this._removeEventListeners({include:["click"]}),this.setCursor("crosshair");const r=()=>{this.setCursor(i),this._addEventsListeners({include:["click"]}),this.mapAdapter.emitter.off("click",o),this._coordFromMapClickAbort=void 0},o=e=>{r(),s.deprecatedMapClick(e),t(e.lngLat)};this.mapAdapter.emitter.once("click",o),this._coordFromMapClickAbort=r}))}_emitStatusEvent(t,e){const s=t;this._eventsStatus[s]=!0,this.emitter.emit(s,e)}async _addLayerProviders(){}async _onLoadSync(){}async _setupMap(){if(!this.mapAdapter)throw new Error("WebMap `mapAdapter` option is not set");return await this.mapAdapter.create(this.options),this._zoomToInitialExtent(),await this._addLayerProviders(),await this._onLoadSync(),this._emitStatusEvent("build-map",this.mapAdapter),this}_setTileJsonOptions(t){t.center&&(this.options.center=t.center),t.bounds&&(this.options.bounds=t.bounds),s.defined(t.maxzoom)&&(this.options.zoom=t.maxzoom),s.defined(t.minzoom)&&(this.options.zoom=t.minzoom),s.defined(t.maxzoom)&&s.defined(t.minzoom)&&(this.options.zoom=(t.maxzoom+t.minzoom)/2)}_zoomToInitialExtent(){const{center:t,zoom:e,bounds:s}=this.options;this._extent?this.fitBounds(this._extent):t&&e?this.setView(t,e):s&&(this.fitBounds(s),void 0!==e&&this.setZoom(e))}_setInitMapState(t){for(const e of t){const t=new e(this);this.mapState.push(t);for(const e of this.runtimeParams){const s=e.get(t.name);if(void 0!==s){const e=t.parse(s);this._initMapState[t.name]=e,Object.defineProperty(this.options,t.name,{value:e,configurable:!0,enumerable:!0});break}}}}_addEventsListeners(t){let e=["preclick","click","zoomstart","zoom","zoomend","movestart","move","moveend","mousemove","mouseout","mouseover"];t&&t.include&&(e=e.filter((e=>t.include.includes(e)))),e.forEach((t=>{this._mapEvents[t]=e=>{if(this.runtimeParams.length){this.mapState.filter((e=>e.event.includes(t))).forEach((t=>{const e=t.toString();this.runtimeParams.forEach((s=>{s.set(t.name,e)}))}))}this._eventsStatus&&this.emitter.emit(t,e)};const e=this._mapEvents[t];e&&this.mapAdapter.emitter.on(t,e)}))}_removeEventListeners(t){let e=Object.entries(this._mapEvents);t&&t.include&&(e=e.filter((e=>t.include.includes(e[0])))),e.forEach((([t,e])=>{e&&this.mapAdapter.emitter.removeListener(t,e)}))}};x(V,"keys",new class{constructor(){L(this,"keyCodeAlias",new m),L(this,"keys",{}),L(this,"_windowOnFocus"),L(this,"_keysPressed"),L(this,"_keysReleased"),this._windowOnFocus=this.windowOnFocus.bind(this),this._keysPressed=this.keysPressed.bind(this),this._keysReleased=this.keysReleased.bind(this),this.addKeyboardEventsListener()}pressed(t){const e=this.keyCodeAlias[t];return!!e&&this.keys[e]}addKeyboardEventsListener(){"undefined"!=typeof window&&(window.addEventListener("focus",this._windowOnFocus,!1),window.addEventListener("keydown",this._keysPressed,!1),window.addEventListener("keyup",this._keysReleased,!1))}removeKeyboardEventsListener(){"undefined"!=typeof window&&(window.removeEventListener("focus",this._windowOnFocus,!1),window.removeEventListener("keydown",this._keysPressed,!1),window.removeEventListener("keyup",this._keysReleased,!1))}keysPressed(t){t.stopPropagation(),this.keys[t.keyCode]||(this.keys[t.keyCode]=!0)}keysReleased(t){t.stopPropagation(),this.keys[t.keyCode]=!1}windowOnFocus(){this.keys={}}}),x(V,"getPaintFunctions");let T=V;var z=Object.defineProperty,I=(t,e,s)=>((t,e,s)=>e in t?z(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s)(t,"symbol"!=typeof e?e+"":e,s);class j extends T{constructor(t){super(t),I(this,"_layersIdCounter",1),I(this,"_layersOrderCounter",1),I(this,"_baselayers",[]),I(this,"_layers",{}),I(this,"_selectedLayers",[]);const e=this.options.tileJson;e&&this.emitter.once("build-map",(()=>this.addTileJsonLayer(e)))}async fitLayer(t,e){const s=this.getLayer(t),i=s&&(s.getBounds||s.getExtent);if(i){const t=await i.call(s);t&&this.fitBounds(t,e)}}isBaseLayer(t){const e=this.getLayer(t);if(e&&e.id)return-1!==this._baselayers.indexOf(e.id)}getBaseLayers(){const t=[];return this._baselayers.forEach((e=>{const s=this._layers[e];s&&t.push(s)})),t}getBaseLayersIds(){return this._baselayers}getLayer(t){return"string"==typeof t?this._layers[t]:t}getLayerId(t){const e=this.getLayer(t);if(e){if(e.id)return null==e?void 0:e.id;if(e&&e.options)return e.options.id}throw new Error("No id for layer")}getLayers(){return Object.keys(this._layers)}allLayers(){return this._layers}orderedLayers(){return Object.values(this._layers).sort(((t,e)=>t.order&&e.order?t.order-e.order:0))}findLayer(t){for(const e in this._layers){const s=this._layers[e];if(t(s))return s}}isLayerVisible(t){const e=this.getLayer(t);return!(!e||void 0===e.options.visibility)&&e.options.visibility}async addBaseLayer(t,e){return await this.addLayer(t,{...e,baselayer:!0},void 0)}async addLayer(t,e={},i){var r,o;const a=this._layersIdCounter++,n=s.defined(i)?i:void 0!==e.order?e.order:this.reserveOrder();let l;"string"==typeof t?l=this.getLayerAdapter(t):"function"==typeof t?l=t:"then"in t&&(l=await t);const d=e;this._updateGeoJsonOptions(d);const h=null==(r=(e={id:String(a),order:n,...e}).visibility)||r;if(e.visibility=!1,e.baselayer&&(e.order=0),this.options.onBeforeAddLayer){const t=this.options.onBeforeAddLayer({options:e,adapter:l});t&&(t.options&&(e=t.options),t.adapter&&(l=t.adapter))}if(void 0!==l){const t=new l(this.mapAdapter.map,e);let s;t.options={...e,...t.options},t.options.baselayer&&(e.baselayer=!0,e.order=0,t.options.order=0),t.options.id&&(s=String(t.options.id),this._layers[s]=t),this._emitLayerEvent("layer:preadd",s||"",t),await this.onMapLoad(),t.map=this.mapAdapter.map;const i=await t.addLayer(t.options);if(t.layer=i,t.id=t.options.id||String(a),t.options.id=t.id,e.baselayer&&(t.options.order=0),t.order=null!=(o=t.options.order)?o:n,s&&delete this._layers[s],s=String(t.id),this._layers[s])throw Error(`layer with id '${s}' already exist`);s&&(this._layers[s]=t,d.filter&&this.filterLayer(t,d.filter),e.baselayer&&this._baselayers.push(s),h&&await this.showLayer(s));const r=e.opacity;null!=r&&r<=1&&this.setLayerOpacity(t,r);const p=i&&(t.getBounds||t.getExtent);if(e.fit&&p){const e=await p.call(t);e&&await this.fitBounds(e)}return e.onAdded&&e.onAdded(t),this._emitLayerEvent("layer:add",s,t),t}return Promise.reject("No adapter")}async addLayerFromAsyncAdapter(t,e,s){const i=s||void 0!==e.order?e.order:this.reserveOrder(),r=t(),o=await r;return o?this.addLayer(o,e,i):Promise.reject("No adapter")}removeLayers(t){for(const e in this._layers){let s=!0;t&&(s=t(e,this._layers[e])),s&&(this.removeLayer(e),delete this._layers[e])}}async getLegend(t){const e=[];for(const s of this.orderedLayers())s.getLegend&&e.push(s.getLegend(t));return(await Promise.all(e)).flat()}reserveOrder(){return this._layersOrderCounter++}removeOverlays(){this.removeLayers(((t,e)=>!(e&&e.options&&e.options.baselayer)))}removeLayer(t){const e=this.getLayer(t),s=e&&this.getLayerId(e);if(e&&s){if(this.emitter.emit("layer:preremove",e),e.beforeRemove&&e.beforeRemove(),e.removeLayer?e.removeLayer():this.mapAdapter.removeLayer(e.layer),e.options&&e.options.baselayer){const t=this._baselayers.indexOf(s);t&&this._baselayers.splice(t,1)}delete this._layers[s],this.emitter.emit("layer:remove",e)}}addGeoJsonLayer(t={},e){return(t=t||{}).multiselect=void 0!==t.multiselect&&t.multiselect,t.unselectOnSecondClick=void 0===t.unselectOnSecondClick||t.unselectOnSecondClick,e||(t=c(t)),t.paint=t.paint||{},this.addLayer(e||"GEOJSON",t)}addFeatureLayer(t={}){return this.addGeoJsonLayer(t)}addTileLayer(t,e={}){return this.addLayer("TILE",{...e,url:t})}addImageLayer(t,e){let s;return"string"==typeof t?s=t:(s=t.url,e=t),this.addLayer("IMAGE",{...e,url:s})}showLayer(t,e={}){return this.toggleLayer(t,!0,e)}hideLayer(t,e={}){return this.toggleLayer(t,!1,e)}toggleLayer(t,e,s={}){const i=this.getLayer(t),r=void 0!==e?e:!(i&&i.options.visibility),o=void 0!==s.silent&&s.silent,a=async t=>{const e=String(t.id),s=r?"layer:show":"layer:hide";if(o||(this._emitLayerEvent(r?"layer:preshow":"layer:prehide",e,t),this._emitLayerEvent("layer:pretoggle",e,t)),r&&this.mapAdapter){const e=t.options.baselayer?0:t.options.order;if(t.options.baselayer&&this._baselayers.length){const e=this._baselayers.filter((e=>e!==t.id&&this.isLayerVisible(e)));for(const t of e)await this.hideLayer(t)}t.showLayer?await t.showLayer.call(t,t.layer):void 0!==t.layer&&await this.mapAdapter.showLayer(t.layer),void 0!==e&&this.mapAdapter.setLayerOrder(t.layer,e,this._layers)}else t.hideLayer?await t.hideLayer.call(t,t.layer):void 0!==t.layer&&await this.mapAdapter.hideLayer(t.layer);t.options.visibility=r,o||(this._emitLayerEvent(s,e,t),this._emitLayerEvent("layer:toggle",e,t))};return i?this.onMapLoad().then((()=>a(i))):Promise.resolve()}updateLayer(t,e){const s=this.getLayer(t);if(s){if(s.updateLayer)return Promise.resolve(s.updateLayer(e));if(this.isLayerVisible(s))return this.hideLayer(s,{silent:!0}).then((()=>this.showLayer(s,{silent:!0})))}return Promise.resolve()}setLayerOpacity(t,e){const s=this.getLayer(t);s&&(s.setOpacity?s.setOpacity(e):this.mapAdapter.setLayerOpacity&&this.mapAdapter.setLayerOpacity(s.layer,e))}isLayerLabelVisible(t){var e;const s=this.getLayer(t);return s.isLabelVisible?s.isLabelVisible():null==(e=s.options.labelVisibility)||e}showLayerLabel(t){this.toggleLayerLabel(t,!0)}hideLayerLabel(t){this.toggleLayerLabel(t,!1)}toggleLayerLabel(t,e){const s=this.getLayer(t);return e=null!=e?e:!this.isLayerLabelVisible(t),s&&(e?s.showLabel&&(s.options.labelVisibility=!0,s.showLabel()):s.hideLabel&&(s.options.labelVisibility=!1,s.hideLabel()),s.id&&this._emitLayerEvent("layer:label:toggle",s.id,s)),e}selectLayer(t,e){const s=this.getLayer(t);if(s){s&&s.select&&s.select(e);const t=this.getLayerId(s);t&&this._selectedLayers.push(t)}}unSelectLayer(t,e){const s=this.getLayer(t);if(s){const t=s&&s;t.unselect&&t.unselect(e);const i=this.getLayerId(s);if(i){const t=this._selectedLayers.indexOf(i);-1!==t&&this._selectedLayers.splice(t,1)}}}unSelectLayers(){const t=Object.values(this.allLayers());let e;for(e of t)e.unselect&&e.unselect()}filterLayer(t,e){const s=this.getLayer(t);return s.filter?s.filter(e):[]}propertiesFilter(t,s,i){const r=this.getLayer(t);if(r){const t=r;if(t.propertiesFilter)return t.propertiesFilter(s,i);t.filter&&this.filterLayer(t,(t=>!t.feature||!t.feature.properties||e.propertiesFilter(t.feature.properties,s)))}return Promise.resolve()}removeLayerFilter(t){const e=this.getLayer(t);e.removeFilter?e.removeFilter():e.filter&&e.filter((()=>!0))}setLayerData(t,e){const s=this.getLayer(t);if(s){if(s.setData)return s.setData(e);if(s.clearLayer&&s.addData)return s.clearLayer(),s.addData(e)}return Promise.resolve()}addLayerData(t,e){const s=this.getLayer(t);s.addData&&s.addData(e)}clearLayerData(t,e){const s=this.getLayer(t);s&&s.clearLayer&&s.clearLayer(e)}setLayerPaint(t,e){const s=this.getLayer(t);e&&s&&s.setPaint&&s.setPaint(e)}setLayerSelectedPaint(t,e){const s=this.getLayer(t);e&&s&&s.setSelectedPaint&&s.setSelectedPaint(e)}updateLayerPaint(t,e){const s=this.getLayer(t);e&&s&&s.updatePaint&&s.updatePaint(e)}updateLayerSelectedPaint(t,e){const s=this.getLayer(t);e&&s&&s.updateSelectedPaint&&s.updateSelectedPaint(e)}getAttributions(t){const e=[];for(const s in this._layers){const i=this._layers[s];let r=!(void 0===t.onlyVisible||t.onlyVisible)||i.options.visibility;if(r&&t.onlyBaselayer&&(r=this._baselayers.includes(s)),r){const t=i.options&&i.options.attribution;t&&e.push(t)}}return e}getActiveBaseLayer(){const t=this.getBaseLayers().find((t=>this.isLayerVisible(t)));if(t)return this.getLayer(t)}addTileJsonLayer(t){return this.addLayer("TILE",{url:t.tiles[0],maxZoom:t.maxzoom,minZoom:t.minzoom,subdomains:t.scheme,attribution:t.attribution})}_emitLayerEvent(t,e,i){const r=String(t);if(s.defined(e)&&r.startsWith("layer:")){const t=r.replace("layer:","layer-"+e+":");this.emitter.emit(t,i)}this.emitter.emit(t,i)}async _onLayerClick(t){return this._emitLayerEvent("layer:click",t.layer.id||"",t),Promise.resolve(t)}async _onLayerDoubleClick(t){return this._emitLayerEvent("layer:dblclick",t.layer.id||"",t),Promise.resolve(t)}async _onLayerSelect(t){return this._emitLayerEvent("layer:select",t.layer.id||"",t),Promise.resolve(t)}_updateGeoJsonOptions(e){const{onSelect:i,onLayerSelect:r,onClick:o,onDoubleClick:a,onLayerClick:n,onMouseOut:l,onMouseOver:d}=e,h=o||n,p=a||n;e.onClick=t=>(h&&h(t),this._onLayerClick(t)),e.onDoubleClick=t=>(p&&p(t),this._onLayerDoubleClick(t)),e.onMouseOut=t=>{const e=t.layer.id;l&&l(t),s.defined(e)&&this._emitLayerEvent("layer:mouseout",e,t)},e.onMouseOver=t=>{const e=t.layer.id;d&&d(t),s.defined(e)&&this._emitLayerEvent("layer:mouseover",e,t)};const c=i||r;e.onSelect=t=>(c&&c(t),this._onLayerSelect(t)),e.nativePaint||(this.options.paint&&(e.paint=t.preparePaint({paint:e.paint||{},defaultPaint:this.options.paint,getPaintFunctions:this.getPaintFunctions})),e.selectedPaint&&this.options.selectedPaint&&(e.selectedPaint=t.preparePaint({paint:e.selectedPaint,defaultPaint:this.options.selectedPaint,getPaintFunctions:this.getPaintFunctions})))}}var Z=Object.defineProperty,D=(t,e,s)=>((t,e,s)=>e in t?Z(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s)(t,"symbol"!=typeof e?e+"":e,s);const G=class t extends j{constructor(){super(...arguments),D(this,"_loadControlQueue",{"top-right":[],"bottom-right":[],"top-left":[],"bottom-left":[]}),D(this,"_isControlLoading",{"top-right":!1,"bottom-right":!1,"top-left":!1,"bottom-left":!1})}async addControl(t,e,s){let i;if(e=null!=e?e:"top-left",i="string"==typeof t?this.getControl(t,s):t,i)return new Promise((t=>{this._setControlQueue(e,(async()=>{const s=await i,r=this.mapAdapter.addControl(s,e);t(r)}))}))}async createControl(t,e){if(await this.onLoad("build-map"),this.mapAdapter.createControl)return this.mapAdapter.createControl(t,e)}async createButtonControl(t){if(await this.onLoad("build-map"),this.mapAdapter.createButtonControl)return this.mapAdapter.createButtonControl(t)}async createToggleControl(t){return await this.onLoad("build-map"),this.mapAdapter.createToggleControl?this.mapAdapter.createToggleControl(t):this.mapAdapter.createButtonControl?n(this.mapAdapter.createButtonControl,t):void 0}removeControl(t){"remove"in t?t.remove():this.mapAdapter.removeControl&&Promise.resolve(t).then((t=>{this.mapAdapter.removeControl(t)}))}getControl(e,s){const i=this.mapAdapter.controlAdapters[e];if(i)return new i(s);{const i=t.controls[e];if(i)return i(this,s)}}getControlContainer(){if(this.mapAdapter.getControlContainer)return this.mapAdapter.getControlContainer()}_setControlQueue(t,e){this._loadControlQueue[t].push(e),this._isControlLoading[t]||this._applyControls(t)}async _applyControls(t){if(this._loadControlQueue[t].length){this._isControlLoading[t]=!0;const e=this._loadControlQueue[t][0];await e(),this._loadControlQueue[t].splice(0,1),this._applyControls(t)}else this._isControlLoading[t]=!1}};D(G,"controls",{CONTROL:(t,e)=>t.createControl(e.control,e.options),BUTTON:(t,e)=>t.createButtonControl(e),TOGGLE:(t,e)=>t.createToggleControl(e)});let J=G;class R extends J{constructor(t){super(t),this._addControls(),a(this.id,this)}static get(t){return o(t)}async _addLayerProviders(){for await(const t of this._starterKits)if(t.getLayerAdapters){const e=await t.getLayerAdapters.call(t);if(e)for await(const t of e){const e=await t.createAdapter(this);e&&(this.mapAdapter.layerAdapters[t.name]=e)}}}async _onLoadSync(){for await(const e of this._starterKits)if(e.onLoadSync)try{await e.onLoadSync.call(e,this)}catch(t){console.error(t)}}_addControls(){this.options.controls&&this.options.controls.forEach((t=>{let e=t,s={};"string"==typeof t&&this.options.controlsOptions&&this.options.controlsOptions[t]&&(s=this.options.controlsOptions[t],void 0!==s.control&&(e=s.control));const{position:i,...r}=s;this.addControl(e,i||"top-left",r)})),this._emitStatusEvent("controls:create")}}exports.WebMap=R,exports.WebMapControls=J,exports.WebMapLayers=j,exports.WebMapMain=T,exports.createToggleControl=n,exports.createWebMap=async function(t){return new R(t).onLoad()},exports.detectGeometryType=d,exports.findMostFrequentGeomType=l,exports.getDefaultControls=function(){return["ZOOM","ATTRIBUTION"]},exports.getWebMap=o,exports.paintTypeAlias=h,exports.setWebMap=a,exports.typeAlias=p,exports.updateGeoJsonAdapterOptions=c;
//# sourceMappingURL=webmap.cjs.prod.js.map
